{{ header }}{{ column_left }}
<div id="content">
    <!-- ========== HEADER ========== -->
    <div class="page-header">
        <div class="container-fluid">
            <!-- USER TOOLS -->

            <div class="pull-right">
                <button type="submit" form="form-grab" data-toggle="tooltip" title="{{ button_save }}"
                        class="btn btn-primary"><i class="fa fa-save"></i></button>
                <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default">
                    <i class="fa fa-reply"></i></a>
                <button id="start_grab" type="submit" data-toggle="tooltip" class="btn btn-success"
                        data-original-title="Старт сканирования">
                    <i class="fa fa-play" aria-hidden="true"></i>
                </button>
                <button id="stop_grab" type="submit" data-toggle="tooltip" class="btn btn-warning"
                        data-original-title="Остановить сканирование">
                    <i class="fa fa-stop" aria-hidden="true"></i>
                </button>
            </div>
            <h1>{{ heading_title }}</h1>
            <!-- BREADCRUMBS -->
            <ul class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                    <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div><!-- /header -->
    <!-- ========== CONTENT ========== -->
    <div class="container-fluid">
        {% if (error) %}
            <div class="alert alert-danger">
                <i class="fa fa-info-circle"></i>{{ error }}
            </div>
        {% elseif (success) %}
            <div class="alert alert alert-success">
                <i class="fa fa-info-circle"></i>{{ success }}
            </div>
        {% endif %}
        <div class="alert alert alert-success" hidden id="msg">
            <i class="fa fa-info-circle"></i>{{ ' Сканирование завершено' }}
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <div class="panel-heading">
                    <!-- NAVIGATION -->
                    <ul class="nav nav-tabs">
                        {% for page in pages %}
                            <li role="presentation" class="{{ page['active'] }}">
                                <a href="{{ page['href'] }}" id="home-tab" role="tab" aria-controls="home"
                                   aria-expanded="true">
                                    {{ page['title'] }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>

                </div>
            </div>
            <div class="panel-body">
                <form method="post" enctype="multipart/form-data" id="form_del" class="form-horizontal"></form>
                <form method="post" enctype="multipart/form-data" id="form_file" class="form-horizontal"></form>
                <form method="post" enctype="multipart/form-data" id="form_seve_link_round"
                      class="form-horizontal"></form>
                <form method="post" enctype="multipart/form-data" id="form_seve_link" class="form-horizontal"></form>
                <form method="post" enctype="multipart/form-data" id="form" class="form-horizontal">
                    <div class="tab-content">
                        <div class="tab-pane active">
                            <!-- simpleparspage start -->
                            <div id="progress" class="form-group" hidden>
                                <label class="col-sm-2 control-label">Производится сбор ссылок</label>
                                <div class="col-sm-10">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-warning progress-bar-striped active"
                                             style="width: 100%">
                                            <span id="info_count" class="show"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-2">
                                    <label id="lol" for="input-pr">Проект<span data-toggle="tooltip"
                                                                               data-original-title="Название проекта"></span></label>
                                    <input name="dn_name" type="text" value="{{ name }}" id="input-pr"
                                           class="form-control" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-9">
                                    <label for="link_round">Ссылки на товары<span data-toggle="tooltip"
                                                                                  data-original-title="В этом поле записаны ссылки которые модуль будет использовать для парсинга в интернет магазин."></span></label>


                                    <div class="panel panel-default"
                                         style="max-height: 300px;min-height: 200px; overflow: auto;">
                                        <ul class="list-unstyled" style="white-space: nowrap;">
                                            {% for key,href in hrefs %}
                                                <li class="{{ href['class'] }}">
                                                    <span>[<a title="Открыть страницу в новом окне браузера" target="_blank" href="{{ href['link'] }}"> {{ key }} </a>] </span>
                                                    <span title="{{ href['message'] }}"> [{{ href['status'] }}]</span>
                                                    <span>{{ href['link'] }}</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>

                                    <div>
{#                                        <button type="submit" name="seve_links_sen" class="btn btn-success"#}
{#                                                form="form_seve_link_round">#}
{#                                            <i class="fa fa-floppy-o" aria-hidden="true"></i> Сохранить ссылки#}
{#                                        </button>#}
                                        <button type="submit" name="del_link_round" id="del_link_round"
                                                class="btn btn-danger" form="form_del"
                                                onclick="return confirm('Вы уверены что хотите очистить список очереди сканирования ?')">
                                            <i class="fa fa-trash" aria-hidden="true"></i> {{ 'Очистить список' }}
                                        </button>
{#                                        <button type="submit" name="use_filter_round"#}
{#                                                class="btn btn-primary "><i class="fa fa-filter"#}
{#                                                                            aria-hidden="true"></i> {{ 'Повторить фильтрацию' }}#}
{#                                        </button>#}
{#                                        <button type="submit" name="links_sen_restart"#}
{#                                                class="btn btn-warning "><i aria-hidden="true"></i>Вернуть ссылки в#}
{#                                            очередь сканирования#}
{#                                        </button>#}

                                        <p class="text-right"><span
                                                    class="text-danger">{{ 'Обработано ссылок: ' ~ count_finish_scan }}</span>
                                            |
                                            <span
                                                    class="text-success">{{ 'Ссылок в очереди: '~round_links_prepare }}</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <label for="link_round">Какие ссылки показывать<span data-toggle="tooltip"
                                                                                         data-original-title="Фильтация ссылок"></span></label>

                                    {% for key, linkFilter in linkFilters %}
                                    <p>
                                        <input type="radio" name="status"
                                               value="{{ key }}" {{ linkFilter['checked'] }}
                                               class="subForm">
                                        <label>{{ key }}:&nbsp;{{ linkFilter['name'] }} ({{ linkFilter['count'] }})</label>
                                        {% endfor %}

                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-9">
                                    <label for="links">Очередь сканирования ссылок<span data-toggle="tooltip"
                                                                                        data-original-title="В этом поле записываются ссылки по которым будет ходить модуль в поиске ссылок на товар."></span></label>
                                    Тут будет грид111

                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                            <tr>
                                                <td style="width: 1px;" class="text-center">
                                                    <input type="checkbox" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);"/>
                                                </td>
                                                <td class="text-left">{% if sort %}
                                                        <a href="{{ sort_name }}" class="{{ order|lower }}">#=№ п/п {{ column_name }}</a>
                                                    {% else %}
                                                        <a href="{{ sort_name }}">name {{ column_name }}</a>
                                                    {% endif %}</td>
                                                <td class="text-center">{% if sort == 'link' %}
                                                        <a href="{{ sort_link }}" class="{{ order|lower }}">link {{ column_link }}</a>
                                                    {% else %}
                                                        <a href="{{ sort_link }}">link {{ column_link }}</a>
                                                    {% endif %}</td>

                                                <td class="text-center">{% if sort == 'modulname' %}
                                                        <a href="{{ sort_modulname }}"
                                                           class="{{ order|lower }}">modulname {{ column_modulname }}</a>
                                                    {% else %}
                                                        <a href="{{ sort_modulname }}">modulname {{ column_modulname }}</a>
                                                    {% endif %}</td>

                                                <td class="text-center">{% if sort == 'minid' %}
                                                        <a href="{{ sort_minid }}"
                                                           class="{{ order|lower }}">minid {{ column_minid }}</a>
                                                    {% else %}
                                                        <a href="{{ sort_minid }}">minid {{ column_minid }}</a>
                                                    {% endif %}</td>

                                                <td class="text-center">{% if sort == 'maxid' %}
                                                        <a href="{{ sort_maxid }}"
                                                           class="{{ order|lower }}">maxid {{ column_maxid }}</a>
                                                    {% else %}
                                                        <a href="{{ sort_maxid }}">maxid {{ column_maxid }}</a>
                                                    {% endif %}</td>

                                                <td class="text-center">{% if sort == 'mult' %}
                                                        <a href="{{ sort_mult }}"
                                                           class="{{ order|lower }}">column_mult {{ column_mult }}</a>
                                                    {% else %}
                                                        <a href="{{ sort_mult }}">mult {{ column_mult }}</a>
                                                    {% endif %}</td>

                                                <td class="text-center">{% if sort == 'status' %}
                                                        <a href="{{ sort_status }}"
                                                           class="{{ order|lower }}">column_status {{ column_status }}</a>
                                                    {% else %}
                                                        <a href="{{ sort_status }}">status {{ column_status }}</a>
                                                    {% endif %}</td>

                                                <td class="text-center">action {{ column_action }}</td>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% if sites %}
                                                {% for site in sites %}
                                                    <tr>
                                                        <td class="text-center">{% if site.site_id in selected %}
                                                                <input type="checkbox" name="selected[]" value="{{ site.id }}"
                                                                       checked="checked"/>
                                                            {% else %}
                                                                <input type="checkbox" name="selected[]" value="{{ site.id }}"/>
                                                            {% endif %}</td>
                                                        <td class="text-left">{{ site.name }}</td>
                                                        <td class="text-left">{{ site.link }}</td>
                                                        <td class="text-left">{{ site.modulname }}</td>
                                                        <td class="text-left">{{ site.minid }}</td>
                                                        <td class="text-left">{{ site.maxid }}</td>
                                                        <td class="text-left">{{ site.mult }}</td>
                                                        <td class="text-left">{{ site.status }}                                             <span>({{ site.productcount }})</span>
                                                        </td>

                                                        <td class="text-right">
                                                            {# TODO: надо предусмотреть сброс статуса, если парсинг завис #}
                                                            {% if (site.modulname != 'noModule') and (site.status not in ['get', 'parse']) %}
                                                                {% set btnStyle = 'btn-default' %}
                                                                {% if site.status == 'ok' %}
                                                                    {% set btnStyle = 'btn-primary' %}
                                                                {% elseif (site.status in ['new'])  %}
                                                                    {% set btnStyle = 'btn-danger' %}
                                                                {% endif %}

                                                                {# выводим кнопки по экспорту#}
                                                                {% if site.productcount > 0 %}
                                                                    <a href="{{ site.export }}" data-toggle="tooltip"
                                                                       title="{{ button_export }}" class="btn {{ btnStyle }}"><i
                                                                                class="fa fa-file-excel-o"></i> Экспорт</a>
                                                                    <a href="{{ site.getimage }}" data-toggle="tooltip"
                                                                       title="{{ button_getimage }}" class="btn {{ btnStyle }} clickmodalimg"><i
                                                                                class="fa fa-file-image-o"></i></a>
                                                                {% endif %}

                                                                <a href="{{ site.get }}" data-toggle="tooltip"
                                                                   title="{{ button_get }}" class="btn btn-primary"><i
                                                                            class="fa fa-clock-o"></i> get</a>

                                                            {% endif %}

                                                            {% if (site.status not in ['get', 'parse']) %}
                                                                <a href="{{ site.edit }}" data-toggle="tooltip" title="{{ button_edit }}"
                                                                   class="btn btn-primary"><i class="fa fa-pencil"></i></a>
                                                            {% endif %}
                                                        </td>


                                                    </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td class="text-center" colspan="4">{{ text_no_results }}</td>
                                                </tr>
                                            {% endif %}
                                            </tbody>
                                        </table>
                                    </div>

                                    <div>
                                        <button type="submit" name="seve_links" class="btn btn-success"
                                                form="form_seve_link">
                                            <i class="fa fa-floppy-o" aria-hidden="true"></i> Сохранить ссылки
                                        </button>
                                        <button type="submit" name="del_finish_link" class="btn btn-danger"
                                                form="form_del"
                                                onclick="return confirm('Вы уверены что хотите очистить список ссылок на товары ?')">
                                            <i class="fa fa-trash" aria-hidden="true"></i> {{ 'Очистить список' }}
                                        </button>
                                        <button type="submit" name="use_filter_finish"
                                                class="btn btn-primary"><i class="fa fa-filter"
                                                                           aria-hidden="true"></i> {{ 'Повторить фильтрацию' }}
                                        </button>
                                        <p class="text-right">{{ 'Найдено ссылок: '~links_prepare }}</p>

                                    </div>
                                </div>
                            </div>
                            <label for="filter_link_domain">Импорт ссылок из файла<span data-toggle="tooltip"
                                                                                        data-original-title="Для загрузки ссылок вам необходимо выбрать в какой список вы хотите добавить ссылки. Затем выбрать текстовый файл с ссылками, где ссылки записаны в столбик. То есть каждая ссылка записана с новой строки. Обратите внимание что при загрузке ссылок с файла, все ссылки проходят фильтрацию по вашим настройкам и в модуль будут добавлены только те ссылки что соответствуют ваши фильтрам. "></span></label>
                            <div class="form-group">
                                <div class="col-sm-4">
                                    <div class="input-group">
                                        <label class="input-group-btn">
                                            <input name="import" type="file" form="form_file" class="main_input_file"/>
                                            <div class="btn btn-default">Выбрать файл…</div>
                                        </label>
                                        <input type="text" class="form-control" id="import" value="Файл не выбран."
                                               readonly>
                                        <span class="input-group-btn">
                    <button class="btn btn-success" type="submit" form="form_file" name="file" value="file_links">
                      <i class="fa fa-download" aria-hidden="true"></i> Импортировать ссылки
                    </button>
                  </span>
                                    </div>
                                    <script>
                                        $(document).ready(function () {
                                            $(".main_input_file").change(function () {
                                                var f_name = [];
                                                for (var i = 0; i < $(this).get(0).files.length; ++i) {
                                                    f_name.push(" " + $(this).get(0).files[i].name);
                                                }
                                                $("#import").val(f_name.join(", "));
                                            });
                                        });
                                    </script>
                                    <style>
                                        input[type="file"] {
                                            display: none;
                                        }
                                    </style>
                                </div>

                            </div>
                            <!-- /simpleparspage stop-->
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div><!-- /content -->
</div>
<style>

    .progress {
        position: relative;
        margin-top: 9px;
    }

    .progress span {
        position: absolute;
        display: block;
        width: 100%;
        color: black;
    }

    .float-right {
        float: right !important;
    }

    label > span:after {
        font-family: FontAwesome;
        color: #1E91CF;
        content: "\f059";
        margin-left: 4px;
    }
</style>
<script>
    var iteration = 0;
    $(document).ready(function () {
        $("#start_grab").bind("click", function () {
            $("#progress").show();
            job = 1;
            //Поучаем настройки формы.
            var value = getForm();

            //Прооверочка на то что стартовая ссылка указана. 
            if (value.start_link == "") {
                $("#progress").hide();
                $("#msg").attr('class', 'alert alert alert-danger');
                $("#msg").text("Не указана стартовая ссылка!!!");
                $("#msg").show();
            } else {
                ajaxpars(value);
            }

        });

        function ajaxpars(value) {
            iteration++;
            if (typeof value === 'undefined') {
                value = 'Rassol2';
            }
            console.log(iteration);
            $.ajax({
                url: 'index.php?route=catalog/simplepars/parsajax&{{ adap['token'] }}&who=grab&i=' + iteration + '&dn_id={{ dn_id }}',
                type: "POST",
                data: value,
                dataType: "html",
                success: function (data) {
                    answ = $.parseJSON(data);
                    console.log(answ);
                    if (answ.status == 'go') {
                        $("#info_count").text("Просканированно " + answ.other.sen_count + " | В очереди " + answ.other.sen_count_no + " | Собрано " + answ.other.link_count)
                        agenpars();
                    } else if (answ.status == 'link_end') {
                        $("#msg").text(answ.msg);
                        $("#msg").show();
                        $("#progress").hide();
                    } else if (answ.status == 'finish') {
                        $("#msg").text(answ.msg);
                        $("#msg").show();
                        $("#progress").hide();
                    }
                }
            });
        };

        function agenpars() {
            $("#stop_grab").bind("click", function () {
                $("#progress").hide();
                job == 0;
                location.reload();
            });
            if (job == 1) {
                ajaxpars();
            }
            ;
        };

        function getForm() {
            // создадим пустой объект
            var $data_form = {};
            // переберём все элементы input, textarea и select формы с id="myForm "
            $('#form').find('input, textarea, select').each(function () {
                // добавим новое свойство к объекту $data
                // имя свойства – значение атрибута name элемента
                // значение свойства – значение свойство value элемента
                $data_form[this.name] = $(this).val();

                //Выбираем правильные чекбоксы.
                if ($("#filter_round_method").prop("checked")) {
                    $data_form.filter_round_method = 'and';
                } else {
                    $data_form.filter_round_method = 'or';
                }

                if ($("#filter_link_method").prop("checked")) {
                    $data_form.filter_link_method = 'and';
                } else {
                    $data_form.filter_link_method = 'or';
                }

                //удаляем ссылки.
                delete $data_form.link_round;
                delete $data_form.links;

            });
            //console.log($data_form);
            return $data_form;
        }

        $(function(){
            $('.subForm').click(function(){
                if($(this).is(":checked"))
                    $('#form').submit();
            })
        });
});
</script>
{{ footer }}